#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/types.h>
#include <unistd.h>
#include <signal.h>
#include <wait.h>
#include <time.h>
#include <sys/shm.h>
#include <sys/msg.h>
#include <semaphore.h>
#include <fcntl.h>   
#include <pthread.h>
#include <errno.h>
#include <error.h>

void CreerStructure();
void DetruireStructure();
void Affect();
void EtudiantN();
void EtudiantF();

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


typedef struct info_filiere{
    int nomFiliere;
    int nbrplaces;
    float Moymin;

}info_filiere;

typedef struct Tompon{ 
    int nom;
    int typeEtudiant;
    float moy;
    int filiere;
    int typeReq; 
}Tompon;

typedef struct Messages{
   int nom;
   int typeEtudiant; 
   int typeRep; 
   int fillaff; 
   int fildem;
}Messages;

typedef struct tableGerant{
   int nom;
   int typeEtudiant;
   float moy;
   int typeRep; 
   int fildem;
   int fillaff; 
   int nombreDesistement;
}tableGerant;


typedef struct Table_Etudiant
{   int nom;
    int  typeEtudiant;
    float moy;
    int filiere;
    int typeReq;
}Table_Etudiant;

typedef struct TSreq
{
    int finSreq; 
    Tompon sreq[5];

}TSreq;


typedef struct Boite_msg
{
    long int mtype;
    Messages msg;

}Boite_msg;



/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


info_filiere filieres[3] = {{1,5,15},{2,5,13},{3,5,12}};
int memoire_id,boite_id,index_gerant=0,index_message=0;
sem_t *nplien, *nvide, *mutex,*mutex_aff;
TSreq *Sreq;
tableGerant TG[20];
Boite_msg rep_etudiant[20];
char *typeReponse[] ={"Inscrit","Complet","Exclu  "};

#define N 5
#define Nbetud 5




//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


void CreerStructure(){
    // intialiser la memoire partagee  
    memoire_id = shmget(IPC_PRIVATE, sizeof(TSreq), IPC_CREAT | 0666);
    Sreq = shmat(memoire_id, 0, 0);
    
    //create msg en cas d'erreure
    boite_id = msgget(75, 0666 | IPC_CREAT);
        if(boite_id<0){
        perror("msgget returned -1\n");
        error(-1, errno, " ");
        exit(-1);
    }
    
    //creer les semaphores 
    mutex_aff  = sem_open ("mutex_aff", O_CREAT , 0644, 1); 
    mutex  = sem_open ("mutex", O_CREAT , 0644, 1);
    nplien = sem_open ("plien", O_CREAT , 0644, 0); 
    nvide  = sem_open ("nvide", O_CREAT , 0644, N);
    sem_unlink ("nvide");  
    sem_unlink ("plien");  
    sem_unlink ("mutex");  
    sem_unlink ("mutex_aff");  

}





void DetruireStructure(){
   msgctl(boite_id, IPC_RMID, NULL);
   shmdt(Sreq);
   shmat(memoire_id,NULL,0);
}





int Faire_insc(Messages reponse){
   int fildem1 = reponse.fildem-1;
   while (fildem1<3)
   {
      if (TG[index_gerant].moy >= filieres[fildem1].Moymin && filieres[fildem1].nbrplaces>0)
      { 
      TG[index_gerant].fillaff  = fildem1+1;
      filieres[fildem1].nbrplaces -=1;

      return 1;
      }   
      else if(filieres[fildem1].nbrplaces==0)
      {
         TG[index_gerant].fillaff  = -1;
          return 2;   
      }
      
      fildem1+=1;
      
  }
   TG[index_gerant].fillaff  = -1;
   return 3;
}    







int Desistement(Messages reponse,int i){
   int fildem1 = reponse.fildem-1;
   while (fildem1<3)
   {
      if (TG[i].moy >= filieres[fildem1].Moymin && filieres[fildem1].nbrplaces>0)
      { 
      TG[index_gerant].fillaff  = fildem1+1;
      filieres[fildem1].nbrplaces -=1;

      return 1;
      }
            else if(filieres[fildem1].nbrplaces==0)
      {
         TG[index_gerant].fillaff  = -1;
          return 2;   
      }
   
      
      fildem1+=1;
      
  }
   TG[index_gerant].fillaff  = -1;
   return 2;
}    

 




int Faire_insc_N(Messages reponse){
   int fildem1=0;
   while (fildem1<=3)
   {
      if (TG[index_gerant].moy >= filieres[fildem1].Moymin && filieres[fildem1].nbrplaces>0)
      { 
      TG[index_gerant].fillaff  = fildem1+1;
      filieres[fildem1].nbrplaces -=1;
      return 1;
      }
   
         fildem1+=1;
      
  }
  if(filieres[fildem1].nbrplaces==0)
      {
         TG[index_gerant].fillaff  = -1;
          return 2;   
      }
  
}  







int ChercherEtudiant(Tompon demande)
{ int j=0;	  
  while (j<10)
  { 
     if (TG[j].nom ==demande.nom)
     { 
	return j;
     }
      j++;
  }
   return -1;	  
}



Table_Etudiant Lire(FILE* Fichier,int R)
{  Table_Etudiant etudiant;
   if (R == 'F' ){  
   fscanf(Fichier, "%d,%f,%d,%d\n", &(etudiant.nom), &(etudiant.moy) , &(etudiant.filiere),&(etudiant.typeReq));
     etudiant.typeEtudiant=2; 
     
  }
  else if(R== 'N'){
         fscanf(Fichier, "%d,%f\n", &(etudiant.nom), &(etudiant.moy) );
         etudiant.typeEtudiant=1;  
    
  }
  
  return etudiant;
}


void Desposer(Table_Etudiant etudiant){

          Sreq->sreq[(*Sreq).finSreq%5].nom = etudiant.nom;
          Sreq->sreq[(*Sreq).finSreq%5].moy = etudiant.moy;
          Sreq->sreq[(*Sreq).finSreq%5].typeEtudiant = etudiant.typeEtudiant;
          Sreq->sreq[(*Sreq).finSreq%5].filiere = etudiant.filiere;
          Sreq->sreq[(*Sreq).finSreq%5].typeReq = etudiant.typeReq;
          (*Sreq).finSreq ++;
}





void AfficherAffect(){
       printf("\n\nEtudiant        Moyenne        filiere Demander        filiere Affecter \n\n");
       for(int i =0 ; i<index_gerant; i++){
	   printf("    %d            %.2f                %d                     %d\n",TG[i].nom,TG[i].moy, TG[i].fildem, TG[i].fillaff);  
	}
	
}









void EtudiantF(){
    Table_Etudiant etudiantF[Nbetud];
    FILE *Req;

    int i=0,desists ;

    Req=fopen("FichF.txt","r");
    

	while(i <Nbetud)
      {
            
            etudiantF[i]= Lire(Req,'F');
            sem_wait(nvide);
            sem_wait(mutex);
            Desposer(etudiantF[i]);  
            sem_post(mutex);
            sem_post(nplien);
            msgrcv(boite_id, &rep_etudiant[index_message], sizeof(Messages), etudiantF[i].typeEtudiant, 0);
           // rep_etudiant[index_message]=msg;
            if (rep_etudiant[index_message].msg.typeRep== 1 && etudiantF[i].filiere != rep_etudiant[index_message].msg.fillaff )    {        
                desists =  rand() % 3;
                if (desists==1){
		          etudiantF[i].typeReq=2;
		          etudiantF[i].filiere=rand() % 3 ;

		          sem_wait(nvide);
		          sem_wait(mutex);
		          Desposer(etudiantF[i]);
					  
					      
		         sem_post(mutex);
		         sem_post(nplien);
		         msgrcv(boite_id, &rep_etudiant[index_message], sizeof(Messages),  etudiantF[i].typeEtudiant, 0);
		         //rep_etudiant[index_message] = msg;
                         //index_message++;
                          index_gerant+=1;


                 if (rep_etudiant[index_message].msg.typeRep==1 && etudiantF[i].filiere != rep_etudiant[index_message].msg.fillaff ){
                     desists =  rand() % 3 ;

                     if (desists==1){
                        etudiantF[i].typeReq=2;
                        etudiantF[i].filiere=rand() % 3 ;
                        sem_wait(nvide);
                        sem_wait(mutex);             
                        Desposer(etudiantF[i]);	    
                        sem_post(mutex);
                        sem_post(nplien);              
                        msgrcv(boite_id, &rep_etudiant[index_message], sizeof(Messages),  etudiantF[i].typeEtudiant, 0);
                        //rep_etudiant[index_message] = msg;
                        //index_message++;
                         index_gerant+=1;

                       
                      }
                      
                      
                   }
                  

               }
            }
              printf("Etudiant %d Reponse %s  filiere Demander %d      filiere Affecter %d\n",rep_etudiant[i].msg.nom,typeReponse[rep_etudiant[i].msg.typeRep-1],rep_etudiant[i].msg.fildem, rep_etudiant[i].msg.fillaff);
            index_message++;
         
    
           i++;
         

           
      } 
      
    etudiantF[i].typeReq=0;
    sem_wait(nvide);
    sem_wait(mutex);
    Desposer(etudiantF[i]);        
    sem_post(mutex);
    sem_post(nplien);
    fclose(Req);
    sem_wait(mutex_aff);
    //printf("\n\nReponse Finale Pour les etudiants F\n\n");
   // MessageFinale();
    sem_post(mutex_aff);
    exit(0);
     
}






void EtudiantN(){
    Table_Etudiant etudiantN[Nbetud];

    FILE *Req;

    int i=0;

 

    Req=fopen("FichN.txt","rt");
  	while(i < Nbetud)
       {
       
            etudiantN[i] = Lire(Req,'N');
     
            sem_wait(nvide);
            sem_wait(mutex);            
             Desposer(etudiantN[i]); 
            sem_post(mutex);
            sem_post (nplien);
            msgrcv(boite_id, &rep_etudiant[index_message], sizeof(Messages),  etudiantN[i].typeEtudiant, 0);
              printf("Etudiant %d Reponse %s  filiere Demander %d      filiere Affecter %d\n",rep_etudiant[i].msg.nom,typeReponse[rep_etudiant[i].msg.typeRep-1],rep_etudiant[i].msg.fildem, rep_etudiant[i].msg.fillaff);
            index_message++;

             i++;
             

   }
    etudiantN[i].typeReq=0;
    sem_wait(nvide);
    sem_wait(mutex);            
    Desposer(etudiantN[i]); 
    sem_post(mutex);
    sem_post (nplien);
    fclose(Req);  

    sem_wait(mutex_aff);
    //printf("\n\nReponse Finale Pour les etudiants N\n\n");
    //MessageFinale();
   sem_post(mutex_aff);
    exit(0);
    


}






void Affect(){
   Tompon demande;
   Boite_msg msg; 
   Messages reponse;
   int nbrFini=0,index =0;

    

   
    do {
        sem_wait(nplien);
        
        demande= Sreq->sreq[index %5];
        index++;
        sem_post(nvide);
        
       if (demande.typeReq != 0)
       {
          if (demande.typeEtudiant == 2)
         {   
              
               if (demande.typeReq==1)
               {  
                  // inscription 
                  // enregistrer dans table gerant 
                  TG[index_gerant].nom=demande.nom;
                  TG[index_gerant].typeEtudiant=demande.typeEtudiant;
                  TG[index_gerant].moy=demande.moy;
                  TG[index_gerant].fildem=demande.filiere;
                  TG[index_gerant].nombreDesistement=0;
                   
                  // reponse
                  reponse.typeEtudiant=demande.typeEtudiant;
                  reponse.nom=demande.nom;
                  reponse.fildem=demande.filiere;
                  reponse.typeRep=Faire_insc(reponse);
                  reponse.fillaff=TG[index_gerant].fillaff;
                  index_gerant+=1;
                  
             
                }
               else if(demande.typeReq==2)  //Desistement
               {  
                

                  int i = ChercherEtudiant(demande);
                  if (i==-1){exit(-1);}
                  TG[i].nombreDesistement+=1;
                  TG[index_gerant].nom = TG[i].nom;
                  TG[index_gerant].fildem = demande.filiere;
                  TG[index_gerant].moy = demande.moy;
                  if(TG[i].nombreDesistement==1)
                  {
                     reponse.typeEtudiant=demande.typeEtudiant;
                     reponse.nom=demande.nom;
                     reponse.fildem=demande.filiere;
                     reponse.typeRep=Desistement(reponse,i);
                     reponse.fillaff=TG[index_gerant].fillaff;

                  }
                  else
                  {
                  
                           reponse.typeEtudiant=demande.typeEtudiant;
                           reponse.nom=demande.nom;
                           reponse.fildem=demande.filiere;
                           reponse.typeRep=3;
                           reponse.fillaff=-1;
                           TG[index_gerant].fillaff=-1;
                           TG[i].typeRep=3;

               
                  }  

                   index_gerant+=1;
            
               }





         } 
         else if  (demande.typeEtudiant == 1)
         {
               
            

                  TG[index_gerant].nom=demande.nom;

                  TG[index_gerant].typeEtudiant=demande.typeEtudiant;
                  TG[index_gerant].moy=demande.moy;
                  TG[index_gerant].fildem=-1;
                  TG[index_gerant].nombreDesistement=0;
                  reponse.typeEtudiant=demande.typeEtudiant;
                  reponse.nom=demande.nom;
                  reponse.fildem=-1;
                  reponse.typeRep=Faire_insc_N(reponse);
                  reponse.fillaff=TG[index_gerant].fillaff;
                  index_gerant+=1;
            
               
         }  
        
       msg.mtype =reponse.typeEtudiant;
       msg.msg = reponse;
       msgsnd(boite_id, &msg, sizeof(reponse), 0);

       
      }
      else if (demande.typeReq == 0){nbrFini++;}
    } while (nbrFini<2);
    

   printf("\n\nTable affect :\n\n");
   AfficherAffect();


   exit(0);
    
    
}


void Creer(){

  int id = fork();
  if (id == 0){
  Affect(); 
  }
  id = fork();
  if (id == 0){EtudiantF();}
  id = fork();
  if (id == 0){
  EtudiantN();

  }
  
  wait(0);
  wait(0);
  wait(0);

  
}


int main(){


	CreerStructure();
	Creer();
	
	printf("\nProgramme Fini\n");
	DetruireStructure();

return 0;

}
